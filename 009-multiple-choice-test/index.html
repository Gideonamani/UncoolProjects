<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
	<link rel="manifest" href="./manifest.json">
	<link rel="mask-icon" href="./safari-pinned-tab.svg" color="#5bbad5">
	<meta name="theme-color" content="#f5f5f5">

    <title>Test Your Understanding</title>

	<link rel="stylesheet" type="text/css" href="./css/main.css">
</head>

<body>
	<header>
		
	</header>

	<div class="container home">
		<div class="image-wrapper">
			<img src="./images/icons/icon-size-72.png">
		</div>
		<h1>Welcome to Testor</h1>

		<p>Please choose the test you'd like to take: </p>

		<select>
			<option value="test01"> 1: Способы стопорения резбовых соединений </option>
			<option value="test02"> 2: Стопорение гаек </option>
			<option value="test03"> 3: Стопорение гаек проволокой </option>
			<option value="test04"> 4: Шайбы </option>
			<option value="test05"> 5: Вид пружинных шайб </option>
			<option value="test06"> 6: Способы вывинчивания шпилек </option>
		</select>
		
		<button onclick="goToTestPage()">Proceed</button>

		<div class="cache-test-options">
			<label>
				1
				<input type="checkbox" name="#01" data-test-id="01">
			</label>
		</div>

	</div>

	<footer>
		
	</footer>


	<script src="./js/index.js" type="text/javascript"></script>
	<script src="./js/main.js" type="text/javascript"></script>
	<script type="text/javascript">
		function goToTestPage(){
			const jsonFileName = document.querySelector("select").value;
			window.location.href = "./html/test.html?json="+jsonFileName;
		}

		document.querySelectorAll('.cache-test-options input').forEach(
			inputEl => {
			
			inputEl.addEventListener('change', function(event) {
				event.preventDefault();
				console.log(event);

				var id = this.dataset.testId;
				caches.open('gideonamani-testor-test-#' + id).then(function(cache) {
				  const jsonPath = './json/test'+ id +'.json';
				  fetch(jsonPath).then(function(response) {
				    // /get-article-urls returns a JSON-encoded array of
				    // resource URLs that a given article depends on
				    return response.json();
				  }).then(function(jsonData){
				  	// calc all the urls resources for this test by reading the image keys
				  	return getImageUrlsFromTestData(jsonData);
				  }).then(function(urls) {
				  	urls.push(jsonPath);
				    cache.addAll(urls);
				  });
				});

			});	
		})	

// <!-- TODO -->
// 1) make proper offline page
// 2) display cached test on offline page
// 3) delete the cached test in storage when user unchecks caching		


		function getImageUrlsFromTestData(testData){
			const urls = [];
			function cleanUrl(url){
				if (url.startsWith("../")) return url.replace("..", ".");
			}
			for (var i = 0; i < testData.list.length; i++) {
				const qn = testData.list[i];
				if(qn.image) urls.push(cleanUrl(qn.image));
				for (var j = 0; j < qn.options.length; j++) {
					const optionImage = qn.options[j].image;
					if(optionImage) urls.push(cleanUrl(optionImage));
				}
			}
			return urls;
		}

	</script>
</body>

</html>


