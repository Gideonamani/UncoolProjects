<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
	<link rel="manifest" href="../manifest.json">
	<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
	<meta name="theme-color" content="#f5f5f5">

    <title> Test </title>

	<link rel="stylesheet" type="text/css" href="../css/main.css">
</head>

<body hidden="true">
	<header>
		
	</header>

	<div id="test-container">
		<div class="container">
			<div class="questions-wrapper">

			</div>
		</div>

		<div class="paginator-wrapper">
			<div class="paginator">
				<button id="prev-question" data-lang-keyword="prev" 
				data-text-case="upperCase">PREV</button>
				<div class="center-content">
					<div>
						<progress value="0" max="100">
					</div>
					<div>
						<p>
							<span data-lang-keyword="page" data-text-case="sentenceCase">Page:</span>
							<span id="question-index"> </span>
							<span data-lang-keyword="of">of:</span>
							<span id="total-questions"> </span>
						</p>
					</div>
					<button id="submit-for-evaluation" data-lang-keyword="submitTestForEval">
						Submit Test for Evaluation 
					</button>
				</div>
				<button id="next-question" data-lang-keyword="next" 
				data-text-case="upperCase">NEXT</button>
			</div>
			<div class="confirm-evaluation">
				<div>
					<p>
						<span data-lang-keyword="notAllQnsAnswered">
							Not all questions are answered.
						</span>
						<span data-lang-keyword="sureToProceedEval">
							Are you sure you want to proceed with evaluation?
						</span>
					</p>
					<button id="cancel-submition">
						<span data-lang-keyword="cancel" data-text-case="upperCase">
						CANCEL</span>
					</button>
					<button id="confirm-submition">
						<span data-lang-keyword="evaluate" data-text-case="upperCase">
						EVALUATE</span>
					</button>
				</div>

				<div>
					<label>
						<p>
							<span data-lang-keyword="highlightOnUnanswered">
								Highlight options on unanswered question?
							</span>
						</p>
						<input id="highlight-unanswered" type="checkbox" name="">
					</label>
				</div>
			</div>
		</div>
	</div>

	<footer>
		
	</footer>


    <div class="page-spinner">
        <div class="spinner">
            <p>
            	<span data-lang-keyword="loading" data-text-case="sentenceCase">
            		Loading
            	</span>...
            </p>
            <div class="cube1"></div>
            <div class="cube2"></div>
        </div>
    </div>

	<div class="templates" style="display: none;">
		<div class="question-wrapper">
			<div class="question-top" style="padding-top: 1px;"></div>
			<section class="question">
				<p class="question-text"></p>
				<div class="image-wrapper">
					<img src="">
				</div>
			</section>

			<section class="options">
			</section>
		</div>

		<label class="option-item">
			<div class="option">
				<div class="option-marker">
					<input type="radio" name="b">
				</div>
				<div class="option-content">
					<div class="image-wrapper">
						<img src="">
					</div>
					<p class="option-text">Lorem ipsum dolor sit amet, consectetur adipisicing elit laborum.</p>
				</div>
			</div>
		</label>
			

		<div class="report-question-wrapper question-wrapper">
			<h3 class="question-number">
				<span data-lang-keyword="question" data-text-case="sentenceCase">Question</span>
				<span class="figure"></span>: 
				<span class="question-evaluation-status"></span>
			</h3>
			<p class="question-text"></p>
			<div class="image-wrapper">
				<img src="">
			</div>

			<ul class="answers">
				<p> 
					<span data-lang-keyword="answer" data-text-case="sentenceCase">Answer</span>:
				</p>
			</ul>

			<ul class="correct">
				<p> 
					<span data-lang-keyword="correct" data-text-case="sentenceCase">Correct</span>:
				</p>
			</ul>

			<ul class="incorrect">
				<p>
					<span data-lang-keyword="incorrect" data-text-case="sentenceCase">Incorrect</span>:
				</p>
			</ul>
		</div>
		
	</div>



	<div class="results-wrapper">
		<div class="container results">
			<h2>
				<span data-lang-keyword="yourTestScoreIs">
				Your test score is
				</span>
			</h2>

			<div id="test-mark">
				<h1>
					<span id="test-score">78</span> %
				</h1>
			</div>

			<div class="further-options">
				<button onclick="retakeTest()">
					<span data-lang-keyword="repeatTest">
					Repeat test
					</span>
				</button>
				<button id="show-full-report">
					<span data-lang-keyword="showFullReport">
					Show full report
					</span>
				</button>
				<button onclick="takeDifferentTest()">
					<span data-lang-keyword="takeDiffTest">
					Take different test
					</span>
				</button>
			</div>
			<div class="further-options" id="save-test-ui-div">
				<label class="center-text">
					<span data-lang-keyword="saveTestForOffline" class="bold">Save test for offline view</span>
					<input id="save-test-input" type="checkbox" name="" onchange="saveOrDeleteTest()">
				</label>
		</div>
	</div>

	<div class="full-report-wrapper">
		<!-- <header><button>Close</button></header> -->
		
		<div class="container full-report">
		</div>

		<footer>
			<button onclick="hideFullReport()">
				<span data-lang-keyword="close" data-text-case="sentenceCase">
					Close
				</span>
			</button>
		</footer>
	</div>


	<script src="../js/main.js" type="text/javascript"></script>
	<script src="../js/language.js" type="text/javascript"></script>
	<script type="text/javascript">
		showLoading();
	</script>
	<script src="../js/class-question.js" type="text/javascript"></script>
	<script src="../js/class-test.js" type="text/javascript"></script>
	<script type="text/javascript">
        const url_string = window.location.href; 
        const url = new URL(url_string);
        const jsonID = url.searchParams.get("json");
        const jsonPath = "../json/"+jsonID+".json";
        checkIfTestSaved();
        cleanLocalStorage();

        let testJSONData;
        getJSON(jsonPath).then( json => {
        	// console.log(jsonPath, "\n", "Data:", json );
        	initTestApp(json);
        	testJSONData = json;
			hideLoading();
        }).catch( err => show404(err) );

        function initTestApp (testJSON){
			const testApp = new Test(testJSON);
			testApp.display();
			document.querySelector("button#next-question").addEventListener("click", e => {
				testApp.showNextQuestion();
			});
			document.querySelector("button#prev-question").addEventListener("click", e => {
				testApp.showPreviousQuestion();
			});
			document.getElementById("submit-for-evaluation").addEventListener("click", e => {
				// check if all the questions are checked				
				const allChecked = (testApp.calcCheckedQuestions() == 100);

				// if all qns are checked, evaluate test
				if (allChecked) testApp.showResults()

				// if not alert the user that not all qns are answered
				if (!allChecked){
					document.querySelector(".paginator-wrapper").classList.add("show-evaluation-confirmation");
				}
			});

			document.getElementById("highlight-unanswered").addEventListener("change", 
				e => testApp.highlightUnansweredQns(e.target.checked));

			document.getElementById("confirm-submition").addEventListener("click", e => {
				// if the user still wants to proceed, evalute
				testApp.showResults();
			});
			document.getElementById("cancel-submition").addEventListener("click", e => {
				// if he cancels eval, then show the paginator
				document.querySelector(".paginator-wrapper").classList.remove("show-evaluation-confirmation");
			});


			document.getElementById("show-full-report").addEventListener("click", e => {
				testApp.showReport();
			});
        }

        function show404(err){
        	console.log(err);
        	window.location.href = err.url;
        }


        function retakeTest(){
        	window.location.reload();
        }

        function takeDifferentTest(){
        	window.location.href = "../";
        }

        function hideFullReport(){
        	const reportWrapper = document.querySelector(".full-report-wrapper");
        	reportWrapper.classList.remove("show");
			var reportNode = reportWrapper.querySelector(".full-report");
			while (reportNode.firstChild) {
			    reportNode.removeChild(reportNode.firstChild);
			}
        }

        function saveOrDeleteTest(){
        	inputChecked = document.getElementById("save-test-input").checked;
        	const storedTests = getFromLocalStorage(localTestStoreName);
        	if (inputChecked) {
        		saveTestForOfflineView(storedTests);
        	}else{
        		removeTestFromCache(storedTests);
        	}
        }

        function toggleEnableSaveTestUI (){
        	document.getElementById("save-test-ui-div").classList.toggle("deactive");
        	const activeState = document.getElementById("save-test-input").disabled;
        	document.getElementById("save-test-input").disabled = !activeState;
        };
        function saveTestForOfflineView(storedTests){
        	toggleEnableSaveTestUI();
    		// storedTest is an object and not an array
    		const testName = testJSONData.name || jsonID;
        	const testDataToBeStored = {name: testName};
        	let newStoredTests = storedTests || {};
    		newStoredTests[jsonID] = testDataToBeStored;
    		putInLocalStorage(localTestStoreName, newStoredTests);
        	
        	saveTestInCache(jsonID).then( () => {
	        	showSnackbar("Test successfully saved.");
	        	setTimeout(function(){
	        		toggleEnableSaveTestUI();
	        	}, 3000);
        	});
        }

        function removeTestFromCache(storedTests){
        	delete(storedTests[jsonID]);
        	putInLocalStorage(localTestStoreName, storedTests);
        	toggleEnableSaveTestUI();

        	deleteTestCache(jsonID).then( () => {
	        	showSnackbar("Test deleted from cache.");
        		toggleEnableSaveTestUI();
        	})
        }

        function cleanLocalStorage(){
        	for ( var i = 0, len = localStorage.length; i < len; ++i ) {
        		const lsKey = localStorage.key(i);
        		if(lsKey.startsWith("storedTests")  && (lsKey !== localTestStoreName)){
        			localStorage.removeItem(lsKey);
        		}
				// console.log( localStorage.getItem( localStorage.key( i ) ) );
			}
        }

        function checkIfTestSaved (){
        	const storedTests = getFromLocalStorage(localTestStoreName);
        	if(!storedTests) return;
        	const saveTestCheckbox = document.getElementById("save-test-input");
        	saveTestCheckbox.checked = !!storedTests[jsonID];
        }
	</script>
</body>

</html>